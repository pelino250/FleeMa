name: CD â€“ Deploy to Staging

on:
  push:
    branches: [develop]

concurrency:
  group: cd-staging
  cancel-in-progress: false

env:
  DEPLOY_HOST: ${{ secrets.STAGING_HOST }}
  DEPLOY_USER: ${{ secrets.STAGING_USER }}
  DEPLOY_PATH: ${{ secrets.STAGING_PATH }}  # e.g. /opt/fleema

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    needs: []
    steps:
      - uses: actions/checkout@v4

      # â”€â”€ SSH Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null

      # â”€â”€ Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy via SSH + Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key "$DEPLOY_USER@$DEPLOY_HOST" bash -s <<'DEPLOY'
            set -euo pipefail
            cd "${{ secrets.STAGING_PATH }}"

            # Pull latest code
            git fetch origin develop
            git reset --hard origin/develop

            # Build and restart
            docker compose build --pull
            docker compose up -d --remove-orphans

            # Run migrations
            docker compose exec -T backend python manage.py migrate --noinput

            echo "âœ… Deployment complete: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          DEPLOY

      # â”€â”€ Smoke test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Smoke test
        run: |
          sleep 10
          STATUS=$(ssh -i ~/.ssh/deploy_key "$DEPLOY_USER@$DEPLOY_HOST" \
            "curl -s -o /dev/null -w '%{http_code}' http://localhost/api/v1/auth/me/")
          if [ "$STATUS" = "401" ]; then
            echo "âœ… API responding (401 = auth required, as expected)"
          else
            echo "âŒ Unexpected status: $STATUS"
            exit 1
          fi

      # â”€â”€ Rollback instructions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Print rollback steps
        if: failure()
        run: |
          echo "## ðŸ”´ Rollback Instructions"
          echo "SSH into \$DEPLOY_HOST and run:"
          echo "  cd ${{ secrets.STAGING_PATH }}"
          echo "  git log --oneline -5   # find last good commit"
          echo "  git reset --hard <good-commit>"
          echo "  docker compose build && docker compose up -d"
          echo "  docker compose exec -T backend python manage.py migrate --noinput"
